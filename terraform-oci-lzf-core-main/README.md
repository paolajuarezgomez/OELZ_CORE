# Oracle Cloud Infrastructure (OCI) Operating Entities Landing Zone (OELZ) Core Terraform Module

# 1. Introduction
This Terraform module provides a generic and configurable way to implement Operating Entity Landing Zones (OELZ) with the following characteristics:

**Shared Operating Model**: The OELZ will have a central team responsible to create the core landing zone resources, known as shared services, and onboard Operating Entities (OE). An OE is an abstraction of an internal organization unit, an Operating Company (OpCo), a subsidiary, or even an LoB. In the OELZ there will be several OEs, and each OE will have the autonomy to operate (create and change) their resources on top of standard pre-defined structures.

**Segregation of Duties**: The OELZ organization has enterprise segregation of resources at the OE level. An OE can onboard different OE departments, which will be responsible for their resources, organized by projects. Projects can have environments and can contain multiple workloads. All layers can be isolated in terms of identity and access management.

**Isolation Resources**:  The isolation of resources is supported by the segregation of duties, and at the network level. The network structure is organized by OE, into environments (production and non-production) and resources in those environments are isolated at the project level, where each project layer has its own security posture. 

# 2. Solution

## 2.1 Getting Started

To make this work, the minimim you'll need will be to define 3 different types of tfvars (in JSON or regular tf format):

1) An OCI credentials tfvar to setup the provider authentication to provision the resources. For additional information check the point `2.6 Inputs`, in this document.   

    ```
    "fingerprint": "<PEM key fingerprint>",
    "private_key_path": "<path to the private key that matches the fingerprint above>",
    "region": "<your region>",
    "tenancy_id": "<tenancy OCID>",
    "user_id": "<user OCID>",
    "home_region": "<home region>",
    "private_key_password": "<private key pwd>"
    ```

2)  A tfvar containing the tenancy compartment structure for the OE, the recommended separation of duties with dedicated compartments for security and networking teams, and security groups and policies. Have a look to the point `2.6 Inputs` to know more about the expected structure and arguments. You CAN tailor this structure in your OE.
   
3) A tfvar container the networking elements for your OE. This is based on the Hub & Spoke topology to enable new OEs to work as Spokes and being attached to the Hub in the Landing Zone. You can customize your VCNs with subnets, route tables, SLs, NSGs as you want. Have a look to the point `2.6 Inputs` to know more about the expected format.

## 2.2 Requirements

Have a valid user with enough IAM policy rights to create new compartments, groups, policies and networking stuff in the parent compartment where you want to create the new OE.

## 2.3 Providers

This module uses the OCI TF Provider [oracle/oci](https://registry.terraform.io/providers/oracle/oci/latest/docs).

## 2.4 Used Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_cislz_compartments"></a> [cislz\_compartments](#module\_cislz\_compartments) | git@github.com:oci-operations-team/terraform-oci-cis-landing-zone-compartments.git | v0.0.1 |
| <a name="module_terraform-oci-cis-landing-zone-network"></a> [terraform-oci-cis-landing-zone-network](#module\_terraform-oci-cis-landing-zone-network) | git@github.com:oci-operations-team/terraform-oci-networking.git | v0.1.7 |

## 2.5 Used Resources

No resources.

## 2.6 Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_compartments"></a> [compartments](#input\_compartments) | The compartments structure, given as a map of objects nested up to 6 levels. | <pre>map(object({<br>    name          = string<br>    description   = string<br>    parent_id     = string<br>    defined_tags  = map(string)<br>    freeform_tags = map(string)<br>    children = map(object({<br>      name          = string<br>      description   = string<br>      defined_tags  = map(string)<br>      freeform_tags = map(string)<br>      children = map(object({<br>        name          = string<br>        description   = string<br>        defined_tags  = map(string)<br>        freeform_tags = map(string)<br>        children = map(object({<br>          name          = string<br>          description   = string<br>          defined_tags  = map(string)<br>          freeform_tags = map(string)<br>          children = map(object({<br>            name          = string<br>            description   = string<br>            defined_tags  = map(string)<br>            freeform_tags = map(string)<br>            children = map(object({<br>              name          = string<br>              description   = string<br>              defined_tags  = map(string)<br>              freeform_tags = map(string)<br>            }))<br>          }))<br>        }))<br>      }))<br>    }))<br>  }))</pre> | `{}` | no |
| <a name="input_enable_compartments_delete"></a> [enable\_compartments\_delete](#input\_enable\_compartments\_delete) | Whether compartments are physically deleted upon destroy. | `bool` | `true` | no |
| <a name="input_fingerprint"></a> [fingerprint](#input\_fingerprint) | n/a | `any` | n/a | yes |
| <a name="input_home_region"></a> [home\_region](#input\_home\_region) | n/a | `any` | n/a | yes |
| <a name="input_network_configuration"></a> [network\_configuration](#input\_network\_configuration) | n/a | <pre>object({<br>    default_compartment_id  = string,<br>    default_compartment_key = string,<br>    default_defined_tags    = map(string),<br>    default_freeform_tags   = map(string),<br><br><br>    network_configuration_categories = map(object({<br>      category_compartment_id  = string,<br>      category_compartment_key = string,<br>      category_defined_tags    = map(string),<br>      category_freeform_tags   = map(string),<br><br>      vcns = map(object({<br>        compartment_id  = string,<br>        compartment_key = string,<br>        display_name    = string<br>        byoipv6cidr_details = map(object({<br>          byoipv6range_id = string<br>          ipv6cidr_block  = string<br>        }))<br>        ipv6private_cidr_blocks          = list(string),<br>        is_ipv6enabled                   = bool,<br>        is_oracle_gua_allocation_enabled = bool,<br>        cidr_blocks                      = list(string),<br>        dns_label                        = string,<br>        is_create_igw                    = bool,<br>        is_attach_drg                    = bool,<br>        block_nat_traffic                = bool,<br>        defined_tags                     = map(string),<br>        freeform_tags                    = map(string),<br><br>        security_lists = map(object({<br>          compartment_id  = string,<br>          compartment_key = string,<br>          defined_tags    = map(string),<br>          freeform_tags   = map(string),<br>          display_name    = string,<br>          ingress_rules = list(object({<br>            stateless    = bool,<br>            protocol     = string,<br>            description  = string,<br>            src          = string,<br>            src_type     = string,<br>            src_port_min = number,<br>            src_port_max = number,<br>            dst_port_min = number,<br>            dst_port_max = number,<br>            icmp_type    = number,<br>            icmp_code    = number<br>          })),<br>          egress_rules = list(object({<br>            stateless    = bool,<br>            protocol     = string,<br>            description  = string,<br>            dst          = string,<br>            dst_type     = string,<br>            src_port_min = number,<br>            src_port_max = number,<br>            dst_port_min = number,<br>            dst_port_max = number,<br>            icmp_type    = number,<br>            icmp_code    = number<br>          }))<br>        }))<br><br>        route_tables = map(object({<br>          compartment_id  = string,<br>          compartment_key = string,<br>          defined_tags    = map(string),<br>          freeform_tags   = map(string),<br>          display_name    = string,<br>          route_rules = map(object({<br>            network_entity_name = string,<br>            description         = string,<br>            destination         = string,<br>            destination_type    = string<br>          }))<br>        }))<br><br>        dhcp_options = map(object({<br>          compartment_id   = string,<br>          compartment_key  = string,<br>          display_name     = string,<br>          defined_tags     = map(string),<br>          freeform_tags    = map(string),<br>          domain_name_type = string,<br>          options = map(object({<br>            type                = string,<br>            server_type         = string,<br>            custom_dns_servers  = list(string)<br>            search_domain_names = list(string)<br>          }))<br>        }))<br><br>        subnets = map(object({<br>          cidr_block      = string,<br>          compartment_id  = string,<br>          compartment_key = string,<br>          #Optional<br>          availability_domain        = string,<br>          defined_tags               = map(string),<br>          dhcp_options_name          = string,<br>          display_name               = string,<br>          dns_label                  = string,<br>          freeform_tags              = map(string),<br>          ipv6cidr_block             = string,<br>          ipv6cidr_blocks            = list(string),<br>          prohibit_internet_ingress  = bool,<br>          prohibit_public_ip_on_vnic = bool,<br>          route_table_name           = string,<br>          security_list_names        = list(string)<br>        }))<br><br>        network_security_groups = map(object({<br>          compartment_id  = string,<br>          compartment_key = string,<br>          defined_tags    = map(string)<br>          freeform_tags   = map(string)<br>          ingress_rules = map(object({<br>            description  = string,<br>            protocol     = string,<br>            stateless    = bool,<br>            src          = string,<br>            src_type     = string,<br>            dst_port_min = number,<br>            dst_port_max = number,<br>            src_port_min = number,<br>            src_port_max = number,<br>            icmp_type    = number,<br>            icmp_code    = number<br>          })),<br>          egress_rules = map(object({<br>            description  = string,<br>            protocol     = string,<br>            stateless    = bool,<br>            dst          = string,<br>            dst_type     = string,<br>            dst_port_min = number,<br>            dst_port_max = number,<br>            src_port_min = number,<br>            src_port_max = number,<br>            icmp_type    = number,<br>            icmp_code    = number<br>          }))<br>        }))<br><br>        vcn_specific_gateways = object({<br>          internet_gateways = map(object({<br>            compartment_id   = string,<br>            compartment_key  = string,<br>            enabled          = bool,<br>            defined_tags     = map(string),<br>            display_name     = string,<br>            freeform_tags    = map(string),<br>            route_table_name = string<br>          }))<br><br>          nat_gateways = map(object({<br>            compartment_id   = string,<br>            compartment_key  = string,<br>            block_traffic    = bool,<br>            defined_tags     = map(string),<br>            display_name     = string,<br>            freeform_tags    = map(string),<br>            public_ip_id     = string,<br>            route_table_name = string<br>          }))<br><br>          service_gateways = map(object({<br>            compartment_id   = string,<br>            compartment_key  = string,<br>            defined_tags     = map(string),<br>            display_name     = string,<br>            freeform_tags    = map(string),<br>            route_table_name = string<br>          }))<br><br>          local_peering_gateways = map(object({<br>            compartment_id   = string,<br>            compartment_key  = string,<br>            defined_tags     = map(string),<br>            display_name     = string,<br>            freeform_tags    = map(string),<br>            peer_id          = string,<br>            peer_name        = string,<br>            route_table_name = string<br>          }))<br>        })<br>      }))<br><br>      inject_into_existing_vcns = map(object({<br><br>        vcn_id = string,<br><br>        security_lists = map(object({<br>          compartment_id  = string,<br>          compartment_key = string,<br>          defined_tags    = map(string),<br>          freeform_tags   = map(string),<br>          display_name    = string,<br>          ingress_rules = list(object({<br>            stateless    = bool,<br>            protocol     = string,<br>            description  = string,<br>            src          = string,<br>            src_type     = string,<br>            src_port_min = number,<br>            src_port_max = number,<br>            dst_port_min = number,<br>            dst_port_max = number,<br>            icmp_type    = number,<br>            icmp_code    = number<br>          })),<br>          egress_rules = list(object({<br>            stateless    = bool,<br>            protocol     = string,<br>            description  = string,<br>            dst          = string,<br>            dst_type     = string,<br>            src_port_min = number,<br>            src_port_max = number,<br>            dst_port_min = number,<br>            dst_port_max = number,<br>            icmp_type    = number,<br>            icmp_code    = number<br>          }))<br>        }))<br><br>        route_tables = map(object({<br>          compartment_id  = string,<br>          compartment_key = string,<br>          defined_tags    = map(string),<br>          freeform_tags   = map(string),<br>          display_name    = string,<br>          route_rules = map(object({<br>            network_entity_id   = string,<br>            network_entity_name = string,<br>            description         = string,<br>            destination         = string,<br>            destination_type    = string<br>          }))<br>        }))<br><br>        dhcp_options = map(object({<br>          compartment_id   = string,<br>          compartment_key  = string,<br>          display_name     = string,<br>          defined_tags     = map(string),<br>          freeform_tags    = map(string),<br>          domain_name_type = string,<br>          options = map(object({<br>            type                = string,<br>            server_type         = string,<br>            custom_dns_servers  = list(string)<br>            search_domain_names = list(string)<br>          }))<br>        }))<br><br>        subnets = map(object({<br>          cidr_block      = string,<br>          compartment_id  = string,<br>          compartment_key = string,<br>          #Optional<br>          availability_domain        = string,<br>          defined_tags               = map(string),<br>          dhcp_options_id            = string,<br>          dhcp_options_name          = string,<br>          display_name               = string,<br>          dns_label                  = string,<br>          freeform_tags              = map(string),<br>          ipv6cidr_block             = string,<br>          ipv6cidr_blocks            = list(string),<br>          prohibit_internet_ingress  = bool,<br>          prohibit_public_ip_on_vnic = bool,<br>          route_table_id             = string,<br>          route_table_name           = string,<br>          security_list_ids          = list(string),<br>          security_list_names        = list(string)<br>        }))<br><br>        network_security_groups = map(object({<br>          compartment_id  = string,<br>          compartment_key = string,<br>          defined_tags    = map(string)<br>          freeform_tags   = map(string)<br>          ingress_rules = map(object({<br>            description  = string,<br>            protocol     = string,<br>            stateless    = bool,<br>            src          = string,<br>            src_type     = string,<br>            dst_port_min = number,<br>            dst_port_max = number,<br>            src_port_min = number,<br>            src_port_max = number,<br>            icmp_type    = number,<br>            icmp_code    = number<br>          })),<br>          egress_rules = map(object({<br>            description  = string,<br>            protocol     = string,<br>            stateless    = bool,<br>            dst          = string,<br>            dst_type     = string,<br>            dst_port_min = number,<br>            dst_port_max = number,<br>            src_port_min = number,<br>            src_port_max = number,<br>            icmp_type    = number,<br>            icmp_code    = number<br>          }))<br>        }))<br><br>        vcn_specific_gateways = object({<br>          internet_gateways = map(object({<br>            compartment_id   = string,<br>            compartment_key  = string,<br>            enabled          = bool,<br>            defined_tags     = map(string),<br>            display_name     = string,<br>            freeform_tags    = map(string),<br>            route_table_id   = string,<br>            route_table_name = string<br>          }))<br><br>          nat_gateways = map(object({<br>            compartment_id   = string,<br>            compartment_key  = string,<br>            block_traffic    = bool,<br>            defined_tags     = map(string),<br>            display_name     = string,<br>            freeform_tags    = map(string),<br>            public_ip_id     = string,<br>            route_table_id   = string,<br>            route_table_name = string<br>          }))<br><br>          service_gateways = map(object({<br>            compartment_id   = string,<br>            compartment_key  = string,<br>            defined_tags     = map(string),<br>            display_name     = string,<br>            freeform_tags    = map(string),<br>            route_table_id   = string,<br>            route_table_name = string<br>          }))<br><br>          local_peering_gateways = map(object({<br>            compartment_id   = string,<br>            compartment_key  = string,<br>            defined_tags     = map(string),<br>            display_name     = string,<br>            freeform_tags    = map(string),<br>            peer_id          = string,<br>            peer_name        = string,<br>            route_table_id   = string,<br>            route_table_name = string<br>          }))<br>        })<br>      }))<br><br>      non_vcn_specific_gateways = object({<br><br>        dynamic_routing_gateways = map(object({<br>          compartment_id  = string,<br>          compartment_key = string,<br>          defined_tags    = map(string),<br>          display_name    = string,<br>          freeform_tags   = map(string),<br><br>          remote_peering_connections = map(object({<br>            compartment_id   = string,<br>            compartment_key  = string,<br>            defined_tags     = map(string),<br>            display_name     = string,<br>            freeform_tags    = map(string),<br>            peer_id          = string,<br>            peer_name        = string,<br>            peer_region_name = string<br>          }))<br><br>          drg_attachments = map(object({<br>            defined_tags         = map(string),<br>            display_name         = string,<br>            freeform_tags        = map(string),<br>            drg_route_table_id   = string,<br>            drg_route_table_name = string,<br>            network_details = object({<br>              attached_resource_id   = string,<br>              attached_resource_name = string,<br>              type                   = string,<br>              route_table_id         = string,<br>              route_table_name       = string,<br>              vcn_route_type         = string<br>            })<br>          }))<br>          drg_route_tables = map(object({<br>            defined_tags                     = map(string),<br>            display_name                     = string,<br>            freeform_tags                    = map(string),<br>            import_drg_route_distribution_id = string,<br>            is_ecmp_enabled                  = bool<br>          }))<br><br>          drg_route_distributions = map(object({<br>            distribution_type = string,<br>            defined_tags      = map(string),<br>            display_name      = string,<br>            freeform_tags     = map(string),<br>            statements = map(object({<br>              action = string,<br>              match_criteria = map(object({<br>                match_type        = string,<br>                attachment_type   = string,<br>                drg_attachment_id = string,<br>              }))<br>              priority = number<br>            }))<br>          }))<br>        }))<br>      })<br>    }))<br>  })</pre> | n/a | yes |
| <a name="input_private_key_password"></a> [private\_key\_password](#input\_private\_key\_password) | n/a | `any` | n/a | yes |
| <a name="input_private_key_path"></a> [private\_key\_path](#input\_private\_key\_path) | n/a | `any` | n/a | yes |
| <a name="input_tenancy_id"></a> [tenancy\_id](#input\_tenancy\_id) | n/a | `any` | n/a | yes |
| <a name="input_user_id"></a> [user\_id](#input\_user\_id) | n/a | `any` | n/a | yes |

## 2.7 Outputs

| Name | Description |
|------|-------------|
| <a name="output_compartments"></a> [compartments](#output\_compartments) | n/a |
| <a name="output_networking_configuration"></a> [networking\_configuration](#output\_networking\_configuration) | n/a |

## 2.8 Operations

### 2.8.1 Add a new compartment

***TBC***

### 2.8.2 Add a new VCN

***TBC***

# 3 Known Problems

## 3.1 Destroy operation may reach timeout while waiting for state to become 'DELETED'

When destroing configuration, delete timeout for compartments may be reached, which is by default 1:30 hours. In that case, try to repeat destroy operation.


# 4. Release Notes

See [release notes](./docs/release_notes.md) for release notes information.

# 5. URLs

You may find additional examples on how to setup at: 

[Examples](https://github.com/oci-operations-team/terraform-oelz-templates-examples/tree/main/patterns/OELZ/examples/lz_central_operations_repo_example/LZ_OPS_CENTRAL_REPO)

# 6. Contributing

This project is open source. Oracle appreciates any contributions that are made by the open source community.

# 7. License

Copyright (c) 2023 Oracle and/or its affiliates.

Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.

See [LICENSE](LICENSE) for more details.
